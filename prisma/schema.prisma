model Course {
  id         String   @id @default(cuid())
  code   String? @unique // èª²è™Ÿï¼Œä¾‹å¦‚ NU101
  name       String
  teacher    String
  credits    Int


   
  required   Boolean?    // å¿…ä¿® / é¸ä¿®
  department String?     // ç³»æ‰€
  grade      Int?        // å¹´ç´š

  createdAt  DateTime @default(now())
  sections   Section[]
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Section {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])

  code      String
  quota     Int

  location  String?     // ğŸ‘ˆ ä¸Šèª²åœ°é»ï¼ˆä½ å‰›å‰›å·²ç¶“é‡åˆ°ï¼‰

  // âš ï¸ rawCourseId ä¸€å®šè¦ä¿ç•™
  rawCourseId String?

  schedules     Schedule[]
  plannerItems  PlannerItem[]

  createdAt DateTime @default(now())
   @@unique([courseId, code])
}


model Schedule {
  id        String   @id @default(cuid())
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  day       Int
  start     Int
  end       Int
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  username     String?
  passwordHash String
  createdAt    DateTime       @default(now())
  tokens       RefreshToken[]
  plannerItems PlannerItem[]
}

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique
  expiresAt   DateTime
  revokedAt   DateTime?
  replacedBy  String?  // æ–° token çš„ hashï¼ˆrotation ç”¨ï¼‰
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}


model PlannerItem {
  id        String   @id @default(cuid())
  userId    String
  sectionId String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, sectionId])    // åŒä¸€ä½¿ç”¨è€…ä¸èƒ½é‡è¤‡åŠ åŒä¸€ç­
  @@index([userId])
  @@index([sectionId])
}
model RawCourse {
  id            String   @id @default(cuid())
  semester      String
  subjectCode   String   // ç§‘ç›®ä»£ç¢¼(æ–°ç¢¼å…¨ç¢¼)
  classGroup    String?  // ä¸Šèª²ç­çµ„
  dayOfWeek     Int?     // ä¸Šèª²æ˜ŸæœŸ
  periods       String?  // ä¸Šèª²ç¯€æ¬¡ (ä¾‹å¦‚ "6,7")
  location      String?  // ä¸Šèª²åœ°é»

  // æŠŠæ•´åˆ—åŸå§‹è³‡æ–™å…ˆå­˜æˆ JSONï¼ˆè¶…å¥½ç”¨ï¼Œå¾Œé¢è¦æ‹†æ¬„ä½å†è™•ç†ï¼‰
  raw           Json

  createdAt     DateTime @default(now())

  // é˜²æ­¢é‡è¤‡åŒ¯å…¥ï¼šç”¨ä½ é‚£åˆ—è³‡æ–™æœ€èƒ½ä»£è¡¨ã€ŒåŒä¸€ç­†é–‹èª²ã€çš„çµ„åˆ
  @@unique([semester, subjectCode, classGroup, dayOfWeek, periods, location])
}

model Planner {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  @@unique([userId, courseId])
}

